---
title: "Instacart - parte 1"
author: "Leonardo Giovanelli, Marcelo Franceschini, Rafael Costa, Sérgio Gomes, Viviane Sanchez"
date: '`r Sys.Date()`'
institute: "PADS - Insper"
encoding: "UTF-8"
output: 
 flexdashboard::flex_dashboard:
    storyboard: true
    social: menu
    source: embed
    
---

```{r setup, include=FALSE, fig.align = 'center'}

knitr::opts_chunk$set(echo = FALSE, fig.cap = TRUE)

library(flexdashboard)
library(plotly)
library(tidyverse)
library(skimr)
library(inspectdf)
library(ggrepel)
library(ggthemes)
library(grid)
library(lubridate)



arquivos <- list.files(path = 'data/', 
                       pattern = "*.csv",
                       full.names = TRUE) %>% sort()

aisles_raw <- read_csv(arquivos[1])

departments_raw <- read_csv(arquivos[2])

#op_prior_raw <- read_csv(arquivos[3])

#op_train_raw <- read_csv(arquivos[4])

orders_raw <- read_csv(arquivos[5])

products_raw <- read_csv(arquivos[6])


orders <- orders_raw %>% 
  mutate(order_hour_of_day = as.numeric(order_hour_of_day))

```

# Referências

- Análise exploratória [Instacart](https://www.instacart.com/datasets/grocery-shopping-2017)

- [Flexdashbaord](https://rmarkdown.rstudio.com/flexdashboard/using.html#overview)

### Recorrência de Pedidos

Row
-------------------------------------

```{r avg_days}

library(d3heatmap)

avg_days_total <- orders %>% 
  group_by(order_dow, order_hour_of_day) %>% 
  summarise(avg_days = mean(days_since_prior_order, na.rm = T)) %>% 
  pivot_wider(names_from = order_hour_of_day, values_from = avg_days) %>% 
  ungroup()

d3heatmap(avg_days_total, scale = 'column')

?d3heatmap

```


```{r avg_days_10, echo = FALSE}

orders_count <- orders %>% 
  group_by(user_id) %>% 
  count() %>% 
  transmute(compras = n)

orders_count_10 <- orders_count %>% 
              filter(compras <= 10)

avg_days_10 <- orders %>% 
  semi_join(orders_count_10, by = 'user_id') %>% 
  group_by(order_dow, order_hour_of_day) %>% 
  summarise(avg_days = mean(days_since_prior_order, na.rm = T)) %>% 
  pivot_wider(names_from = order_hour_of_day, values_from = avg_days) %>% 
  ungroup()


d3heatmap(avg_days_10, scale = 'column')

```

***

Premissas
 -
 -
 -
 
 
# Produtos

- Pré-Análises

```{r produtos}

#sum(!(orders$order_id %in% op_prior$order_id))

orders_rec <- orders %>%
  filter(!is.na(days_since_prior_order))

# Incluindo o produto na base de pedidos anteriores
ord_prior_prod <- op_prior %>% 
  left_join(products)

```


```{r produtos2}

x <- orders_rec_count %>% filter(compras > 10)

mean(x$compras)

base_orders_rec_count_10_complete$compras %>% mean()


base_orders %>% filter(is.na(days_since_prior_order)) %>% count()



```


- Produtos mais consumidospor clientes com menos de 10 pedidos

```{r produtos3}

orders_rec_count <- orders_rec %>% 
  group_by(user_id) %>% 
  count() %>% 
  transmute(compras = n)

orders_rec_count_10 <- orders_rec_count %>% 
              filter(compras <= 10)

orders_rec_count_10 %>% 
  nrow()

orders_rec_count_10_complete <- orders_rec_count_10 %>% 
                                left_join(orders_rec)

orders_rec_count_10_complete_prod <- orders_rec_count_10_complete %>% 
                                          left_join(ord_prior_prod)

orders_rec_count_10_complete_prod_dept <- orders_rec_count_10_complete_prod %>%   
                                          left_join(departments)

base_graf1 <- orders_rec_count_10_complete_prod_dept %>% 
  group_by(department) %>% 
  count() %>% 
  transmute(quantidade = n) %>% 
  arrange(desc(quantidade))

base_graf1[1:10,] %>% 
  ggplot(aes(x = reorder(department, -quantidade), y = quantidade)) +
                      geom_col(na.rm = TRUE)

```

### Persona

